<!-- $Id$ -->
<?php

#	functions specific to auth

#  Copyright (C) 2003  ken restivo <ken@restivo.org>
#
#  some stuff lifted from
#  POST-NUKE Content Management System
#  Copyright (C) 2001 by the Post-Nuke Development Team.
#  http://www.postnuke.com/
#  ----------------------------------------------------------------------
#  Based on:
#  PHP-NUKE Web Portal System - http://phpnuke.org/
#  Thatware - http://thatware.org/
# 
#  This program is free software; you can redistribute it and/or modify
#  it under the terms of the GNU General Public License as published by
#  the Free Software Foundation; either version 2 of the License, or
#  (at your option) any later version.
# 
#  This program is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#  GNU General Public License for more details. 
# 
#  You should have received a copy of the GNU General Public License
#  along with this program; if not, write to the Free Software
#  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA


require_once("movetoshared.inc");


#thank you, phpnuke
define('ACCESS_INVALID', -1);
define('ACCESS_NONE', 0);
define('ACCESS_SUMMARY', 100);
define('ACCESS_VIEW', 200);
define('ACCESS_EDIT', 500);
define('ACCESS_ADD', 600);
define('ACCESS_DELETE', 700);
define('ACCESS_ADMIN', 800);

$accessnames = array(  
		  0 => _ACCESS_NONE,
		100 => _ACCESS_SUMMARY,
		200 => _ACCESS_VIEW,
		500 => _ACCESS_EDIT,
		600 => _ACCESS_ADD,
		700 => _ACCESS_DELETE,
		800 => _ACCESS_ADMIN
);



/******************
	SAVEPASS
	commits this user's new/changed password to the database
	inputs: uid, password in clear text
	returns: a token, generated by call to generateToken()
******************/
function 
savePass($uid, $clearpass)
{
	// be paranoid
	if(!($uid && $clearpass)){
		print "savePass(): ERROR! need to pass in a uid AND a password\n";
		exit(1);
	}

	$hash = strtolower(md5($clearpass));

	$query = sprintf("update users set password = '%s' where userid = %d ",
				$uid, $hash);
	mysql_query($query);
	$err = mysql_error();
	if($err){
		//TODO: log this, don't display it
		print "savePass(): [SECRET]: $err\n";
		return 0;
	}
	
	return generateToken($uid, $hash);

} /* END SAVEPASS */
					


/******************
	GETPASS
	get the password hash stored for this user, 
	inputs: uid
	returns: the hash if OK, 0 if no password, or -1 if no user!
******************/
function 
getPass($uid)
{
	// sanity check
	if($uid < 1){
		print "getPass(): ERROR! $uid < 1\n";
		exit(1);
	}

	// the query
	$query = sprintf("SELECT * FROM users WHERE userid = %d ",
				$uid );
	#print "getPass(): [$query]\n";
	$listq = mysql_query($query);
	$err = mysql_error();
	if($err){
		#TODO: log this, don't display it
		print "getPass(): [SECRET]: $err\n";
	}
				
	while($row = mysql_fetch_assoc($listq)){
		//grab 'em all XXX is this really necessary?
		//printf("debug %s\n", $row['name']);
	}

	if (mysql_num_rows($result) > 0) {
		if($row['password']){
			#print "got one\n";
			return($row['password']); //success!
		} else {
			#print "no password\n";
			return 0; // no password entered yet for this uid
		}
	}                  

	#print "no password\n";
	return 0;
} /* END GETPASS */


/******************
	GENERATETOKEN
	inputs: uid, the hashed password from the db
	returns: a token (md5 hash of hashed passwd in db, and uid
******************/
function
generateToken($uid, $passhash)
{	
	if(!($uid && $passhash)){
		print "generateToken(): ERROR! need to pass in a uid AND a hash\n";
		exit(1);
	}
	//ok, the hash
	return strtolower(md5($uid . strtolower($passhash)));
			
}/* END GENEREATETOKEN */


/******************
	CHECKTOKEN
	check that the token is valid for this uid
	inputs: uid, token
	returns: 0 if ok, 1 if failure
******************/
function
checkToken($uid, $token)
{
	if(!($uid && $token)){
		return 1; // MUST supply both.
	}

	// seemple
	if($token == generateToken($uid, getPass($uid))){
		return 0;
	}	
	
	return 1;
}/* END CHECKTOKEN */


/******************
	CHECKAUTHLEVEL
	check that this uid is authorised to do this action
	inputs: auth structure
	returns: 0 if ok, 1 if failure
******************/
function
checkAuthLevel($auth)
{
	$uid = $auth['uid'];
	$token = $auth['token']; 
	$realm = $auth['realm'];
	$level = $auth['level'];

	if(!($uid && $realm && $token && $level)){
		print "checkAuthLevel(): ERROR not enough info\n";
		return 1;
	}

	if(($err = checkToken($uid, $token)) > 0){
		return $err;
	}

	// the query
	$query = sprintf("
			SELECT * FROM privs 
				left join users on users.userid = privs.userid
			WHERE privs.userid = %d 
				and (privs.realm = '%s' or privs.realm = 'all')
				and privs.authlevel > %d
			--",
			$uid, $realm, $level
		);
	$listq = mysql_query($query);
	$err = mysql_error();
	if($err){
		#TODO: log this, don't display it
		print "checkAuthLevel(): [SECRET]: $err\n";
	}
				
	if (mysql_num_rows($result) > 0) {
		return 0;
	}                  

	return 1;
}/* END CHECKAUTHLEVEL */



/******************
	DISPLAYLOGIN
	inputs: auth
	outputs: shows who they are logged in as, and a "logout" button
			or, a "login here" link
******************/
function
displayLogin($auth)
{
	$uid = $auth['uid'];
	$pwd = $auth['pwd'];
	$confirm = $auth['confirm'];
	$token = $auth['token'];

	
	// well, they're not.
	if(!($uid && $token)){
		printf("You are NOT logged in. <a href='%s'>Login here</a>",
			//XXX should this be menu.php?
			$_SERVER['PHP_SELF']);
		return;
	}

	// reflexively check the token first
	if(($err = checkToken($uid, $token)) > 0){
		print "displayLogin(): bad login!\n";
		return;
	}

	// the query
	$query = sprintf("
		SELECT family.name 
			FROM users 
			left join families on families.familyid = users.familyid
			WHERE users.userid = %d --",
				$uid );
	$listq = mysql_query($query);
	$err = mysql_error();
	if($err){
		#TODO: log this, don't display it
		print "displayLogin(): [SECRET]: $err\n";
	}
				
	// sanity czech
	if (mysql_num_rows($result) < 1) {
		print "displayLogin(): ERROR! no name for family with uid $uid?\n";
		return;
	}

	while($row = mysql_fetch_assoc($listq)){
		$name = $row['name']; 
	}

	printf("You are logged in as %s. <a href='%s'>Logout here</a>",
		$name, $_SERVER['PHP_SELF']);

}/* END DISPLAYLOGIN */



/******************
	LOGINPOPUP
	drawing the popup
		query all users. doy.
		if an id is passed in, use that one as default. 
		otherwise, CHOOSE ONE
	inputs: uid
	outputs: renders the popup
******************/
function loginPopup($uid)
{
	printf("<select name='auth[uid]' SINGLE>\n",
		$entrynum, $fname
	);
	print "<option value='0'>CHOOSE ONE</option>\n";

	#DO THE QUERY
	$listq = mysql_query(" select * from users order by name");
	$err = mysql_error();
	if($err){
		print "loginPopup(): [$listq]: $err\n";
	}
	while($row = mysql_fetch_array($listq)){
		$sel = $row['userid'] == $uid ? " selected" : "";
		printf("<option value='%d' %s>%s</option>\n", 
			$row['userid'], $sel, $row['name']);
 
	}
	print "\n</select>";
}/* END LOGINPOPUP */
	

/******************
	LOGIN
	logs a user in. abstracted here to be used in several places
		functions like a main() for common auth functions
	inputs: an auth struct
	outputs: error messages as needed
	returns: a token if the user is now successfully logged in, otherwise 0.
******************/
function
logIn($auth)
{
	$uid = $auth['uid'];
	$pwd = $auth['pwd'];
	$confirm = $auth['confirm'];
	$token = $auth['token'];

	//hmm. they are supplying a password! must be a new/change request
	if($pwd){
		return newPass($uid, $pwd, $confirm, $token);
	}

	// these aren't the 'droids you're looking for. move along, move along.
	if($token){
		if(checkToken($uid, $token)){
			print "logIn(): ERROR unauthorized\n";
			return 0;
		}
		return $token; //cool, they're already logged in
	}

	//ok! no password or token passed in, so throw up a login screen

	if($uid){
		$oldpwhash = getPass($uid);		
	}

	print "<p>Please log in:</p>";
	print "<table border='0'>";
	#print "DEBUG: $id";
	printf("<FORM METHOD=POST ACTION='%s'>", 
			$_SERVER['PHP_SELF']);
	print "<tr><td>Your child's last name:</td><td>";
	loginPopup($uid); 
	print "</td></tr>";
	if($oldpwhash){
		// if there already IS a password for this family
		print "<tr><td>Your password:</td>";
	} else {
		print "<tr><td>Please make up a NEW password for yourself 
					and type it here:</td>";
	}
	print "<td><INPUT TYPE=password NAME='auth[pwd]'></td>";
	print "</tr>"; // html sucks

	if(!$oldpwhash){
		// confirmation for new user
		print "<tr><td>Type your new password again to confirm:</td>";
		print "<td><INPUT TYPE=password NAME='auth[confirm]'></td></tr>";
	}
	print "<tr><td><INPUT TYPE=submit NAME='login' VALUE='LogIn'></td></tr>";
    print "</FORM>";
	print "</table>";

	return 0;

}/* END LOGIN  */



/******************
	NEWPASS
	ui for user to choose a new password
	inputs: uid, new password (cleartext), confirmation password (cleartext),
		and a token (if changing existing pw)
	outputs: error messages as needed
	returns: a token if success, otherwise 0.
******************/
function
newPass($uid, $newclearpass, $newconfirm, $oldtoken)
{

	// they must enter a confirmation when entering a NEW password
	if(!($newconfirm && $newclearpass) || ($newconfirm != $newclearpass)){
		print "Passwords do not match! Try again\n";
		/* TODO complaint is a form with "try again" button
			and a uid as an invisiblefield */
		return 0;
	}

	// check for existing password, tokens
	$oldpwhash = getPass($uid);		
	if($oldpwhash){
		if($oldpwhash < 0){
			// intruder alert! 
			print "newPass(): ERROR! no such user\n";
			exit(1);
		}
		//there's already a password in there! they must authorized to change
		if(checkToken($uid, $oldtoken)){
			print "Unauthorized to change password. Log in first\n";
			return 0;
		}
	} 

	if(passStandard($newclearpass)){
		// sucky password, dude. try again.
		return 0;
	}

	// they made it through the gauntlet!
	return(savePass($uid, $newclearpass));

}/* END NEWPASS */



/******************
	PASSSTANDARD
******************/
function
passStandard()
{
}/* END PASSTANDARD */



#note bin2hex... do i need it?

?>
<!-- END AUTH -->
