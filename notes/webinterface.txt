notes on web interface
$Id$

main page (with no POST/GET fields)
	popup for choosing family  DONE
		(java auto-submit, and official SUBMIT button too)

main page (with family POST/GET'ed)
	show family information
		parents, kids, session, um... not needed for this
	show number of names, and how many to go until 10 (duh) DONE
	show the actual names entered so far DONE
	entry form
		pick up the parentid from the top (the popup should be inside the form)
		table of 10 entry fields
			last (required)
			first (required)
			business/company
			addr1 (required)
			addr2
			state/province (required, "CA" default)
			zip/postalcode (required, "94044" default)
			oountry (required, "USA" default)
			relationship (required, popup)
				relative, friend, co-worker, alumni, other
		of course, the submit/save button!

admin page
	choose 
		(all families, families with less than 10 names)
		by date
			default next milestone from today
		detailed (all names) or summary (default)
	table of families, and how many names have been entered so far
		um, by certain dates?
		only the delinquent ones?
		and, with email and phone and am/pm (heh) for the springfest cops to use

---------------
OK, CODE!

10names code
	drawing the popup DONE
		query all families. doy.
		if there's an id in POSTVARS, use that one as default. otherwise, CHOOSE
	drawing the basic parent and kids info DONE
		tested tables: col for parents, col for kids
		simple query: into table
	drawing the names-to-date info DONE
		simple query, again.
		it would be nice to show how many days left until cutoffdate
	drawing the web form DONE
		name the fields in a loop: name1, name2, addr1, addr2
		invis field with parentid: because there'll be no popup on this page
		will need a cancel button! so people can get outta there
	czeching DONE
		go through all rows (entry1-x)
			ok, check DONE
				compare with the $fields global
				check that required's have data in 'em
				check that they're less than len or 254 (maybe)
				if not, return an array to display
					copy an empty fields array
					stuff the entered values into =>def
						i'll need to htmlspecialchars() the data first!
					stuff the error description into => error
						and red comments showing what is wrong/missing
			if they are ok, save them! DONE
				send the row array to a save function
					i will need mysql_escape_string() for db insertion!
						or addslashes()
			report broken ones DONE
				create an array of arrays
				redisplay the form, but it will show up as an error form
		should also check that it isn't a duplicate,  DONE
			that someone else hasn't entered it already

admin code
	drawing the chooser (as above and in reprots.txt)
	draw the report

file layout DONE
	like 5mins
	common folder
		dbfuncs.php
		shared.php
			most everything!
				assume it goes here
				popup, parentinfo
		globals.inc
			the HTTPVARS globals etc
			include the dbname
		dbname (for testing)
	index.php
		the basic page display
			if no familyid, 
				draw the chooser,
				done
			else if there is form stuff (how to tell?)
				do the datachecking	
			else draw 
				the basic parentid,kids, names
				and the form!
		header/footer stuff
	10names.php
		specifics to this thing
		names-to-date
		the web form	
		the submission handling
	admin.php
		the reports!
	money.php
		the input for money stuff

texts
	spring fest 10-names donations
		every family must provide the names of 10 people who should be invited to 
			attend or donate to springfest. you must enter these names by 11/04/2003
	choose the name of your family (child's last name)
	you have entered x names so far. you have x days left to enter x more names!
		or.. congratulations! you have already entered your 10 names!
	add more names
		

misc
	array for fields
		including which are required, what defaults, etc
	

money
	an input screen, to enter 
		payer, 
		check num, 
		date (on check?), 
		category  (popup)
			10-names forfeit charge
			food/quilt
			3x5 card forfeit charge
		family popup (if 3x5, quilt, or 10namesforfeit) 
			grab this from 10names
		or, if an RSVP, response code, which is the leadid 
			(future, for RSVP cards: not right now)


security: http auth
	augh. a complete auth model
		users with userid's
			link to parents or families, for further auth
			password (md5)
			are users ALWAYS gonna be parents? add password to parents table?
				if so, i can add the password to the parents table?
			and username/uid. hmm. 
		a userprivs table (many to many to users and areas)
			various mysql-esque booleans with privs
			view
			add
			delete
			edit
			what about su?
				what if i want to have su privs, just view. or just add?
				specifically, privs to edit user privs?
		an area or domain or realm
			"area" being, things. 
				10names
				money
				3x5 (text, not money)
				what else?
		ah!  postnuke is nifty.
			uid
			realm (10names, money, 3x5)
			compennt (i.e. plugin, not releavnt here)
			instance (wha?) i could mean: own family, ALL families, PM families?
			level (action! view/add/delete/edit)
		ugh. if i am truly going to have secure keys, i need a SESSION table
			with randumb number, used for auth'ing actions.
			for super security, regenerate this randumb number for each action
	http auth "login", and a token that gets passed around!
		let's try it as a function, on the money page. no login, no dice.
		footer: a "logged in as" and/or "log out" on every page!
	ah, at some time, an interface for managing user privs!



Basically, it'll be something similar to your report, 			
	but with a FORM on each line, 
		each containing an EDIT button 
			and a hellacious number of hidden fields. 
		That FORM's action would just call the 
			entry screen, and, as if by magick, 
				the user should see all the values 
				pre-populated and ready for editing. 
		A DELETE button could sit in that FORM too, 
			and the main loop would then call a new delete function, 
				possibly throwing up an "are you sure" beforehand....  
					no rest for the wicked.
		The main loop would, 
		if it sees "edit", call the save function with a (new) arg, 
			so that it knows that we're changing not saving, 
			and can conditionally use "update" in the SQL query instead of "insert", 
				DONE
	i either need multiple forms to call, or, have a smart form
		that knows whether it's being called to edit, delete, etc
			where is this now?

goal: simple, reasonably secure way to authorise actions by users
	secure against: accidental misuse, privilege elevation
	NOT secure against: replay attacks or packet sniffing
		
concepts/data structures
	password: passed on the wire as clear text ONCE, when first logging in
		(or TWICE, when user chooses it for the first time, for confirmation)
		stored in hashed format in database: admin/developers can't read it
	token: an md5 hash of the uid and the password's hash
		this opaque token is what gets passed around as the user surfs the site
	realm: an "area" of the site
		10names, money, 3x5 cards, roster, insurance, menu, users
	uid: a user, distinct from family, but linked to a family.
	level(action): levels of authorisation for this user and realm
		none, summary, view detail, edit, add, delete, admin(superuser)

auth.inc: the library functions
	checkToken(): check that the token is valid for this uid
		inputs: uid, token
		returns: thumbs up or thumbs down		
	generateToken()
		inputs: uid, password
		returns: a token
	savePassword(): commits this user's new/changed password to the database
		inputs: uid, password
		returns: a token, generated by call to generateToken()
	checkAuthLevel(): check that this uid is authorised to do this action
		inputs: uid, token, realm, level(action)
		returns: thumbs up or thumbs down	
	displayLogin()
		inputs: uid, token 
		outputs: shows who they are logged in as, and a "logout" button
	logIn(): logs a user in. abstracted here to be used in several places
		inputs: HTTP_POST/GET_VARS
		outputs: error messages as needed
		returns: a token if success, otherwise 0.
		pseudocode:
			if passing in a password via HTTP_VARS
				call auth.inc:newPass()
			if there is a token passed in via HTTP_VARS,
				check token (auth.inc)
					if bad, complain about no auth, and return 0
					if good, return the token!
			else (no password or token passed in)
				show the choose family name popup, 
					if familyid passed in, pre-select it
				and password entry field
				text: if you haven't entered a password before, 
					please CHOOSE a new one now and type it in here
	newPass():  ui for user to choose a new password
		inputs: HTTP_VARS
		outputs: error messages as needed
		returns: a token if success, otherwise 0.
		pseudocode:
			if there is a confirm password also, check that the hash matches
				i.e. they have entered the exact same password twice
				if it does, save new password	
					then call generateToken() and return the token!
				if it doesn't, complain passwords don't match,
					complaint is a form with "try again" button
						and a familyid as an invisiblefield
					return 0
			else 
				if they do NOT have a password in db (i.e. first time), 
					check that it's an acceptable new password 
						(minimum length)
						if OK, 
							show a confirm "choosing new password, 
								please retype to make sure"
							generateToken on this, 
								and stuff token into an invisible field
							link back to $SELF
							return 0
						else 
							complain about bad length, 
								show "try again" form with familyid
							and return 0
				else
					if there is a password in the db, check it, 
						generate token, and show menu
						passing token thru invisibly


menu.php: a nice launching point for things!
	call auth.inc:login() and die if it fails. else...
	show friendlyHappyWelcome from 10names
	show parents and kids in this family, 
		and some roster information: what session (AM/PM), etc.
	menu of choices
		call auth.inc:checkAuthLevel() before displaying each choice
		- enter 10names 
		- enter 3x5 cards 
		- edit roster information (phone, email, name spelling, etc)
		- show insurance information
		- enter checks (if authorised for "money" realm)

admin.php: administrative tasks
	forcibly re-log them in with auth.inc:logIn() 
		so we are reasonably sure that they know their OLD password
	if checkAuthLevel() is ok, 
		call newPass()
	in future, there may be other admin tasks. when so, put up menu of them here
